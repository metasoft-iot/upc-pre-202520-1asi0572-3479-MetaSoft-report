@startuml bc-workshopOps-diagram

skinparam ClassAttributeIconSize 0

left to right direction
package com.safecar.platform.workshopOps {

    package "domain" {
        package "model" {
            package "aggregates" {
                class Workshop {
                    'Root: Workshop
                    -workshopId: WorkshopId
                    +activate(): void
                    +deactivate(): void
                    +rename(newName: String): void
                    +changeTimeZone(tz: String): void
                }
                class VehicleEnrollment {
                    'Root: VehicleEnrollment
                    -enrollmentId: String
                    -workshopId: WorkshopId
                    -vehicle: VehicleId
                    -driver: DriverId?
                    -enrolledAt: Timestamp
                    +enroll(workshopId: WorkshopId, vehicleId: VehicleId, driverId?: DriverId): void
                    +attachDriver(driverId: DriverId): void
                    +detachDriver(): void
                    +suspend(): void
                    +reactivate(): void
                    +leave(): void
                }
                class Scheduling {
                    'Root: Appointment (scheduling and resource assignments)
                    -appointmentId: String
                    -workshopId: WorkshopId
                    +schedule(slot: TimeRange, bay?: BayId): void
                    +reschedule(newSlot: TimeRange, newBay?: BayId): void
                    +start(): void
                    +complete(): void
                    +cancel(reason: String): void
                    +assign(mechanic: MechanicId, window: TimeRange, bay?: BayId): void
                    +reassign(mechanic?: MechanicId, bay?: BayId): void
                    +resizeAssignment(window: TimeRange): void
                    +releaseAssignment(): void
                }
                class WorkOrder {
                    'Root: WorkOrder
                    -workOrderId: String
                    -workshopId: WorkshopId
                    -vehicle: VehicleId
                    -driver: DriverId?
                    -openedAt: Timestamp
                    +open(origin: String, priority: String): void
                    +start(): void
                    +hold(): void
                    +resume(): void
                    +close(): void
                    +cancel(reason: String): void
                    +prioritize(level: String): void
                    +addItem(description: String, estimatedMinutes?: Int): void
                    +startItem(itemId: String): void
                    +completeItem(itemId: String): void
                    +cancelItem(itemId: String): void
                    +attachFaults(snapshot: FaultSnapshot): void
                    +linkAppointment(appointmentId: String): void
                }
                class TelemetryRecord {
                    'Root: TelemetryRecord
                    -eventId: EventId
                    -device: DeviceId
                    -workshopId: WorkshopId
                    -capturedAt: Timestamp
                    -ingestedAt: Timestamp
                    +markEnriched(): void
                    +markPublished(): void
                }
                class TelemetryQuarantine {
                    'Root: TelemetryQuarantineRecord
                    -quarantineId: String
                    -device: DeviceId
                    -workshopId: WorkshopId?
                    -receivedAt: Timestamp
                    -reason: String
                    +addNote(note: String): void
                    +resolveTo(eventId: EventId): void
                    +discard(reason: String): void
                }
            }
            package "entities" {
                class Workshop {
                    -id: WorkshopId
                    -name: String
                    -timezone: String
                    -isActive: Boolean
                    +activate(): void
                    +deactivate(): void
                    +rename(newName: String): void
                    +changeTimeZone(timeZone: String): void
                }
                class MechanicProfile {
                    -id: MechanicId
                    -workshopId: WorkshopId
                    -fullName: String
                    -skills: Set<String>
                    -isActive: Boolean
                }
                class Bay {
                    -id: BayId
                    -workshopId: WorkshopId
                    -label: String
                    -isActive: Boolean
                    +activate(): void
                    +deactivate(): void
                    +rename(label: String): void
                }
                class VehicleEnrollment {
                    -id: String
                    -workshopId: WorkshopId
                    -vehicle: VehicleId
                    -driver: DriverId
                    -enrolledAt: Timestamp
                    -status: Enum {ACTIVE, SUSPENDED, LEFT}
                    +attachDriver(driverId: DriverId): void
                    +detachDriver(): void
                    +suspend(): void
                    +reactivate(): void
                }
                class Appointment {
                    -id: String
                    -workshopId: WorkshopId
                    -vehicle: VehicleId
                    -driver: DriverId?
                    -slot: TimeRange
                    -bay: BayId?
                    -status: Enum {SCHEDULED, IN_PROGRESS, COMPLETED, CANCELLED}
                    -reason: String?
                    -workOrderId: String?
                    +schedule(slot: TimeRange, bay?: BayId): void
                    +reschedule(newSlot: TimeRange, newBay?: BayId): void
                    +start(): void
                    +complete(): void
                    +cancel(reason: String): void
                    +linkWorkOrder(orderId: String): void
                }
                class ResourceAssignment {
                    -id: String
                    -workshopId: WorkshopId
                    -mechanic: MechanicId
                    -bay: BayId?
                    -timeRange: TimeRange
                    -targetType: Enum {APPOINTMENT, WORK_ORDER}
                    -targetId: String
                    +reassign(mechanic?: MechanicId, bay?: BayId): void
                    +resize(window: TimeRange): void
                    +release(): void
                }
                class WorkOrder {
                    -id: String
                    -workshopId: WorkshopId
                    -vehicle: VehicleId
                    -driver: DriverId?
                    -openedAt: Timestamp
                    -closedAt: Timestamp?
                    -status: Enum {OPEN, IN_PROGRESS, ON_HOLD, CLOSED, CANCELLED}
                    -priority: Enum {LOW, NORMAL, HIGH, CRITICAL}
                    -origin: Enum {MANUAL, TELEMETRY, INSPECTION}
                    -linkedFaults: FaultSnapshot?
                    +start(): void
                    +hold(): void
                    +resume(): void
                    +close(): void
                    +cancel(reason: String): void
                    +prioritize(level: String): void
                    +attachFaults(snapshot: FaultSnapshot): void
                    +linkAppointment(appointmentId: String): void
                }
                class WorkOrderItem {
                    -id: String
                    -workOrderId: String
                    -description: String
                    -estimatedMinutes: Int?
                    -status: Enum {PENDING, DOING, DONE, CANCELLED}
                    -assignedMechanic: MechanicId?
                    +start(): void
                    +done(): void
                    +cancel(): void
                    +estimate(minutes: Int): void
                    +assignMechanic(mechanicId: MechanicId): void
                }
                class TelemetryRecord {
                    -eventId: EventId
                    -workshopId: WorkshopId
                    -device: DeviceId
                    -vehicle: VehicleId
                    -driver: DriverId?
                    -capturedAt: Timestamp
                    -ingestedAt: Timestamp
                    -canonical: TelemetryCanonical
                    -processingState: Enum {RECEIVED, ENRICHED, PUBLISHED}
                    +markEnriched(): void
                    +markPublished(): void
                }
                class TelemetryQuarantineRecord {
                    -id: String
                    -workshopId: WorkshopId?
                    -device: DeviceId
                    -receivedAt: Timestamp
                    -reason: String
                    -integrity: IntegrityFlags
                    -rawPayload: String
                    +addNote(note: String): void
                    +resolveTo(eventId: EventId): void
                    +discard(reason: String): void
                }
            }
            package "valueobjects" {
                'Identity and references
                class WorkshopId <<valueobject>> {
                    +value: Long
                }
                class VehicleId <<valueobject>> {
                    +value: Long
                }
                class DriverId <<valueobject>> {
                    +value: Long
                }
                class DeviceId <<valueobject>> {
                    +value: Long
                }
                class MechanicId <<valueobject>> {
                    +value: Long
                }
                class BayId <<valueobject>> {
                    +value: Long
                }
                'Time, clock and order of events
                class Timestamp <<valueobject>> {
                    +lat: Double
                    +lon: Double
                }
                class TimeRange <<valueobject>> {
                    +altMeters: Double?
                }
                class StreamOffset <<valueobject>> {
                    +partition: Int
                    +offset: Long
                }
                class EventId <<valueobject>> {
                    +value: Long
                }
                'Location and movement
                'Geographical position of the vehicle.
                class GeoLocation <<valueobject>> {
                    +value: Long
                }
                'Magnetic/geographic bearing.
                class Heading <<valueobject>> {
                    +value: Long
                }
                'Normalized instantaneous speed.
                class Speed <<valueobject>> {
                    +value: Long
                }
                'Accumulated vehicle distance.
                class Odometer <<valueobject>> {
                    +meters: Long
                }
                'Engine health and fuel
                class EngineRpm <<valueobject>> {
                    +rpm: Int
                }
                class EngineTemp <<valueobject>> {
                    +celsius: Double
                }
                class FuelLevel <<valueobject>> {
                    +percentage: Double
                }
                class BatteryVoltage <<valueobject>> {
                    +volts: Double
                }
                'Diagnosis and severity
                'OBD-II code
                class DtcCode <<valueobject>> {
                    +code: String
                }
                'Criticality assigned by Workshops when
                'normalizing/evaluating events (input for Alerts).
                class SeverityLevel <<valueobject>> {
                    +value: Enum {INFO, WARNING, CRITICAL}
                }
                'Set of active faults at a given moment (basis
                'for generating/updating ServiceOrder or issuing AlertRequest).
                class FaultSnapshot <<valueobject>> {
                    +codes: List<DtcCode>
                    +severity: SeverityLevel
                    +capturedAt: Timestamp
                }
                'Signal quality and packet integrity
                class SignalQuality <<valueobject>> {
                    +rsrDbm: Double?
                    +snrDb: Double?
                    +satellites:Int?
                }
                class IntegrityFlags <<valueobject>> {
                    +outOfOrder: Boolean
                    +duplicate: Boolean
                    +partial: Boolean
                }
                'Telemetry normalization (canonical loading)
                'Normalized and enriched data envelope that WorkshopOps publishes
                'for Insights/Alerts and uses to trigger operational logic (orders/agenda).
                class TelemetryCanonical {
                    +eventId: EventId
                    +capturedAt: Timestamp
                    +ingestedAt: Timestamp
                    +device: DeviceId
                    +vehicle: VehicleId
                    +driver: DriverId
                    +workshop: WorkshopId
                    +location: Geolocation?
                    +heading: Heading?
                    +speed: Speed?
                    +odometer: Odometer?
                    +engineRpm: EngineRpm?
                    +fuel: FuelLevel?
                    +battery: BatteryVoltage?
                    +faults: FaultSnapshot?
                    +signal: SignalQuality?
                    +integrity: IntegrityFlags?
                }
                'Workshop operation (scheduling/order support)
                class AppointmentSlot {
                    +timeRange: TimeRange
                    +bay: BayId
                }
                class AssignmentWindow {
                    +timeRange: TimeRange
                    +mechanic: MechanicId
                    +bay: BayId
                }
                class WorkOrderRef {
                    +workOrderId: string
                }

                'Relations between value objects
                TelemetryCanonical *-- EventId
                TelemetryCanonical *-- Timestamp : capturedAt
                TelemetryCanonical *-- Timestamp : ingestedAt

                TelemetryCanonical *-- DeviceId
                TelemetryCanonical *-- VehicleId
                TelemetryCanonical o-- DriverId          : optional
                TelemetryCanonical *-- WorkshopId

                TelemetryCanonical o-- GeoLocation       : optional
                TelemetryCanonical o-- Heading           : optional
                TelemetryCanonical o-- Speed             : optional
                TelemetryCanonical o-- Odometer          : optional

                TelemetryCanonical o-- EngineRpm         : optional
                TelemetryCanonical o-- FuelLevel         : optional
                TelemetryCanonical o-- BatteryVoltage    : optional

                TelemetryCanonical o-- FaultSnapshot     : optional
                TelemetryCanonical o-- SignalQuality     : optional
                TelemetryCanonical o-- IntegrityFlags    : optional

                'Fault snapshot composition
                FaultSnapshot *-- "0..*" DtcCode
                FaultSnapshot *-- SeverityLevel
                FaultSnapshot *-- Timestamp : capturedAt

                'Time range composition
                TimeRange *-- Timestamp : start
                TimeRange *-- Timestamp : end
            }

            ' Relations between entities and value objects
            'entities.Workshop
            entities.Workshop *-- valuobjects.WorkshopId
            'entities.MechanicProfile
            entities.MechanicProfile *-- valuobjects.MechanicId
            entities.MechanicProfile *-- valuobjects.WorkshopId
            'entities.Bay
            entities.Bay *-- valuobjects.BayId
            entities.Bay *-- valuobjects.WorkshopId
            'entities.VehicleEnrollment
            entities.VehicleEnrollment *-- valuobjects.WorkshopId
            entities.VehicleEnrollment *-- valuobjects.VehicleId
            entities.VehicleEnrollment *-- valuobjects.DriverId
            entities.VehicleEnrollment *-- valuobjects.Timestamp : enrolledAt
            'entities.Appointment
            entities.Appointment *-- valuobjects.WorkshopId
            entities.Appointment *-- valuobjects.VehicleId
            entities.Appointment o-- valuobjects.DriverId        : optional
            entities.Appointment *-- valuobjects.TimeRange       : slot
            entities.Appointment o-- valuobjects.BayId           : optional
            'entities.ResourceAssignment
            entities.ResourceAssignment *-- valuobjects.WorkshopId
            entities.ResourceAssignment *-- valuobjects.MechanicId
            entities.ResourceAssignment o-- valuobjects.BayId    : optional
            entities.ResourceAssignment *-- valuobjects.TimeRange : timeRange
            'entities.WorkOrder
            entities.WorkOrder *-- valuobjects.WorkshopId
            entities.WorkOrder *-- valuobjects.VehicleId
            entities.WorkOrder o-- valuobjects.DriverId          : optional
            entities.WorkOrder *-- valuobjects.Timestamp         : openedAt
            entities.WorkOrder o-- valuobjects.Timestamp         : closedAt
            entities.WorkOrder o-- valuobjects.FaultSnapshot     : optional
            'entities.WorkOrderItem
            entities.WorkOrderItem o-- valuobjects.MechanicId    : optional
            'entities.TelemetryRecord
            entities.TelemetryRecord *-- valuobjects.EventId
            entities.TelemetryRecord *-- valuobjects.WorkshopId
            entities.TelemetryRecord *-- valuobjects.DeviceId
            entities.TelemetryRecord *-- valuobjects.VehicleId
            entities.TelemetryRecord o-- valuobjects.DriverId     : optional
            entities.TelemetryRecord *-- valuobjects.Timestamp    : capturedAt
            entities.TelemetryRecord *-- valuobjects.Timestamp    : ingestedAt
            entities.TelemetryRecord *-- valuobjects.TelemetryCanonical
            'entities.TelemetryQuarantineRecord
            entities.TelemetryQuarantineRecord o-- valuobjects.WorkshopId : optional
            entities.TelemetryQuarantineRecord *-- valuobjects.DeviceId
            entities.TelemetryQuarantineRecord *-- valuobjects.Timestamp  : receivedAt
            entities.TelemetryQuarantineRecord *-- valuobjects.IntegrityFlags

            'Relations between aggregates, entities and value objects
                ' Workshop aggregate
            aggregates.Workshop *-- entities.Workshop
            aggregates.Workshop *-- entities.Bay
            aggregates.Workshop *-- entities.MechanicProfile
            aggregates.Workshop *-- valuobjects.WorkshopId
                ' VehicleEnrollment aggregate
            aggregates.VehicleEnrollment *-- entities.VehicleEnrollment
            aggregates.VehicleEnrollment *-- valuobjects.WorkshopId
            aggregates.VehicleEnrollment *-- valuobjects.VehicleId
            aggregates.VehicleEnrollment o-- valuobjects.DriverId        : optional
            aggregates.VehicleEnrollment *-- valuobjects.Timestamp       : enrolledAt
                'Scheduling aggregate (root: Appointment)
            aggregates.Scheduling *-- entities.Appointment
            aggregates.Scheduling *-- entities.ResourceAssignment
            aggregates.Scheduling *-- valuobjects.WorkshopId
            aggregates.Scheduling *-- valuobjects.TimeRange              : slot/window
            aggregates.Scheduling o-- valuobjects.BayId                  : optional
            aggregates.Scheduling o-- valuobjects.MechanicId             : optional
                ' Link from Appointment to WorkOrder aggregate by id (cross-aggregate reference)
                entities.Appointment ..> aggregates.WorkOrder : link by workOrderId
                ' WorkOrder aggregate
            aggregates.WorkOrder *-- entities.WorkOrder
            aggregates.WorkOrder *-- "0..*" entities.WorkOrderItem
            aggregates.WorkOrder *-- valuobjects.WorkshopId
            aggregates.WorkOrder *-- valuobjects.VehicleId
            aggregates.WorkOrder o-- valuobjects.DriverId                : optional
            aggregates.WorkOrder *-- valuobjects.Timestamp               : openedAt
            aggregates.WorkOrder o-- valuobjects.Timestamp               : closedAt
            aggregates.WorkOrder o-- valuobjects.FaultSnapshot           : optional
                ' Optional link from WorkOrder to Scheduling by appointment id (if used)
                entities.WorkOrder ..> aggregates.Scheduling : link by appointmentId
                'TelemetryRecord aggregate
            aggregates.TelemetryRecord *-- entities.TelemetryRecord
            aggregates.TelemetryRecord *-- valuobjects.EventId
            aggregates.TelemetryRecord *-- valuobjects.DeviceId
            aggregates.TelemetryRecord *-- valuobjects.WorkshopId
            aggregates.TelemetryRecord *-- valuobjects.VehicleId
            aggregates.TelemetryRecord o-- valuobjects.DriverId          : optional
            aggregates.TelemetryRecord *-- valuobjects.Timestamp         : capturedAt
            aggregates.TelemetryRecord *-- valuobjects.Timestamp         : ingestedAt
            aggregates.TelemetryRecord *-- valuobjects.TelemetryCanonical
                'TelemetryQuarantine aggregate
            aggregates.TelemetryQuarantine *-- entities.TelemetryQuarantineRecord
            aggregates.TelemetryQuarantine o-- valuobjects.WorkshopId    : optional
            aggregates.TelemetryQuarantine *-- valuobjects.DeviceId
            aggregates.TelemetryQuarantine *-- valuobjects.Timestamp     : receivedAt
            aggregates.TelemetryQuarantine *-- valuobjects.IntegrityFlags

            package "commands" {

            }
            package "queries" {

            }
            package "events" {

            }
        }
        package "services" {

        }
    }

    package "infrastructure" {
        package "persistence" {
            package "jpa" {
                package "repositories" {

                }
            }
        }
    }

    package "application" {
        package "internal" {
            package "commandservices" {

            }

            package "queryservices" {

            }
        }
    }

    package "interfaces" {

        package "rest" {
            package "resources" {

            }
            package "transform" {

            }
        }


    }
}

@enduml